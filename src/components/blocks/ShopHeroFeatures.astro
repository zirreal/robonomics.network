---
import RbButton from '../RbButton.astro';

const {
  subtitle = $tr('CYBERPUNKS HARDWARE'),
  headline = $tr("FOR PERSONAL USE AT CYBERPUNKS.SHOP!"),
  description = $tr("Every product in the store requires no mandatory subscription, doesn't force you to connect to corporate clouds to control your own devices, doesn't spy on you, and never sells your data to Google's partner network."),
  imageSrc, // Optional - will be randomly selected by script
  imageAlt = 'Cyberpunks Hardware device',
  shopUrl = 'https://cyberpunks.shop',
  cls = ''
} = Astro.props;
---

<section class="devices-hero">
  <div class="layout">
    <h2 class="devices-subtitle title-lined">
      <span>{$tr(subtitle)}</span>
    </h2>
  </div>
  <div class="layout layout__content">
    <p class="devices-headline">{$tr(headline)}</p>
    <p class="devices-description">
      {$tr(description)}
    </p>
  </div>
</section>

<section class=`devices-features ${cls}`>
  <div class="layout layout__content">
    <div class="features-container grid grid-3">
      <!-- Left column - Negative features -->
      <div class="features-column features-column--left">
        <div class="feature-item feature-item--negative">
          <p class="feature-label">{$tr('NO vendor cloud')}</p>
          <div class="feature-icon">
            <img src="/images/icons/no-cloud.svg" alt="No vendor cloud" />
          </div>
        </div>

        <div class="feature-item feature-item--negative">
          <p class="feature-label">{$tr('NO personal data tracking')}</p>
          <div class="feature-icon">
            <img src="/images/icons/no-tracking.svg" alt="No personal data tracking" />
          </div>
        </div>

        <div class="feature-item feature-item--negative">
          <p class="feature-label">{$tr('NO mandatory subscription')}</p>
          <div class="feature-icon">
            <img src="/images/icons/no-subscription.svg" alt="No mandatory subscription" />
          </div>
        </div>
      </div>

      <!-- Center column - Random Image -->
      <div class="feature-image">
        <img id="product-image" src={imageSrc || '/images/shop/random-1.webp'} alt={imageAlt} />
      </div>

      <!-- Right column - Positive features -->
      <div class="features-column features-column--right">
        <div class="feature-item feature-item--positive">
          <div class="feature-icon">
            <img src="/images/icons/open-source.svg" alt="Fully open-source" />
          </div>
          <p class="feature-label">{$tr('Fully open-source')}</p>
        </div>

        <div class="feature-item feature-item--positive">
          <div class="feature-icon">
            <img src="/images/icons/privacy.svg" alt="Privacy by design" />
          </div>
          <p class="feature-label">{$tr('Privacy by design')}</p>
        </div>

        <div class="feature-item feature-item--positive">
          <div class="feature-icon">
            <img src="/images/icons/global.svg" alt="Globally accessible" />
          </div>
          <p class="feature-label">{$tr('Globally accessible')}</p>
        </div>
      </div>
    </div>

    <div class="tech-icons">
      <div class="tech-icon">
        <img src="/images/icons/gh.svg" alt="GitHub" />
      </div>
      <div class="tech-icon">
        <img src="/images/icons/clog.svg" alt="Gear" />
      </div>
      <div class="tech-icon">
        <img src="/images/icons/keyhole.svg" alt="Open Source Initiative" />
      </div>
      <div class="tech-icon">
        <img src="/images/icons/homeassistant.svg" alt="Home Assistant" />
      </div>
      <div class="tech-icon">
        <img src="/images/icons/tasmota.svg" alt="Tasmota" />
      </div>
      <div class="tech-icon">
        <img src="/images/icons/polkadot.svg" alt="Polkadot" />
      </div>
      <div class="tech-icon">
        <img src="/images/icons/ethereum.svg" alt="Ethereum" />
      </div>
    </div>

    <RbButton 
      href={shopUrl} 
      buttonstyle="flat" 
      buttoncolor="blue"
      block
      radius
      extraCls="shop-now-button"
      noTarget={false}
    >
      {$tr('SHOP NOW')}
    </RbButton>
  </div>
</section>

<style>
  /* Hero Section */
  .devices-hero {
    padding: 0;
    margin-bottom: var(--space);
    text-align: center;
  }

  .devices-features.pt {
    padding-top: calc(var(--space) * 2);
  }

  .devices-features.mb {
    margin-bottom: calc(var(--space) * 2);
  }

  .devices-subtitle {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: calc(var(--space) * 1.5);
    font-size: calc(var(--base-font-size) * 2);
    font-variation-settings: var(--font-flex-extrabold);
    text-transform: uppercase;
    color: var(--color-dark);
    margin: calc(var(--space) * 0.5) 0;
    letter-spacing: 2px;
  }

  .devices-headline {
    font-size: calc(var(--base-font-size) * 1.8);
    font-variation-settings: var(--font-flex-extrabold);
    color: var(--color-blue);
    text-transform: uppercase;
    margin: 0;
    margin-bottom: calc(var(--space) * 0.5);
    letter-spacing: 1px;
  }

  .devices-description {
    margin: 0;
    margin-bottom: calc(var(--space) * 0.5);
    font-variation-settings: var(--font-flex-medium);
    color: var(--color-dark);
  }

  .features-container {
    grid-template-columns: 1fr 2fr 1fr;
    align-items: center;
    margin-bottom: calc(var(--space) * 2);
  }

  .feature-image {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    width: 100%;
  }

  .feature-image img {
    width: 100%;
    height: auto;
    object-fit: contain;
    opacity: 1;
    transition: opacity 0.5s ease;
  }

  .features-column {
    display: flex;
    flex-direction: column;
    gap: calc(var(--space) * 0.5)
  }

  .feature-item {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: calc(var(--space) * 0.5);
  }

  .feature-icon {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: end;
  }

  .feature-item--positive .feature-icon  {
    justify-content: start;
  }

  .feature-icon img {
    max-width: 80px;
    height: 80px;
  }

  .feature-label {
    width: 100%;
    font-size: calc(var(--base-font-size) * 0.7);
    font-variation-settings: var(--font-flex-bold);
    color: var(--color-dark);
    margin: 0;
    line-height: 1.4;
  }

  /* Tech Icons Section */
  .tech-icons {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: calc(var(--space) * 1.5);
    flex-wrap: wrap;
    margin-bottom: calc(var(--space) * 1.4);
  }

  .tech-icon {
    width: 50px;
    height: 50px;
    flex-shrink: 0;
  }

  .tech-icon img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  @media screen and (max-width: 680px) {
    .devices-hero {
      margin-bottom: calc(var(--space) * 2);
    }
    
    .devices-subtitle {
      font-size: calc(var(--base-font-size) * 1.4);
    }

    .devices-headline {
      font-size: calc(var(--base-font-size) * 1.3);
    }

    .devices-description {
      font-size: calc(var(--base-font-size) * 1);
    }

    .features-container {
      grid-template-columns: repeat(2, 1fr);
      justify-items: center;
    }

    .feature-icon  {
      width: unset;
    }

    .feature-icon img {
      max-width: 50px;
    }

    .feature-item {
      gap: calc(var(--space) * 0.8);
    }

    .features-column--left  .feature-item  {
      flex-direction: row-reverse;
      align-items: center;
      text-align: left;
    }

    .features-column--left .feature-icon {
      justify-content: start;
    }

    .features-column--left .feature-label {
      text-align: right !important;
    }

    .features-column--right {
      grid-column: 2;
      grid-row: 1;
    }

    .feature-image {
      grid-column: 1 / -1;
      grid-row: 2;
      width: 100%;
    }
  }

  @media screen and (max-width: 390px) {
    .features-container {
      grid-template-columns: 1fr;
      justify-items: start;
    }

    .features-column {
      width: 100%;
    }

    .features-column--left {
      grid-column: 1;
      grid-row: 1;
    }

    .features-column--right {
      grid-column: 1;
      grid-row: 2;
    }

    .feature-label {
      width: unset;
      text-align: right !important;
    }

    .feature-image {
      grid-column: 1;
      grid-row: 3;
    }
  }
</style>

<script>
  // Array of all product images
  const productImages = [
    '/images/shop/random-1.webp',
    '/images/shop/random-2.webp',
    '/images/shop/random-3.webp',
    '/images/shop/random-4.webp',
    '/images/shop/random-5.webp',
    '/images/shop/random-6.webp',
    '/images/shop/random-7.webp',
    '/images/shop/random-8.webp',
    '/images/shop/random-9.webp',
    '/images/shop/random-10.webp'
  ];

  let currentImageIndex = -1;
  let isAnimating = false;
  let fadePhase = 'idle'; // 'idle' | 'out' | 'in'

  function getRandomImage() {
    let randomIndex;
    // Ensure we don't show the same image twice in a row
    do {
      randomIndex = Math.floor(Math.random() * productImages.length);
    } while (randomIndex === currentImageIndex && productImages.length > 1);
    
    currentImageIndex = randomIndex;
    return productImages[randomIndex];
  }

  function changeProductImage() {
    const img = document.getElementById('product-image');
    if (!img || isAnimating) return;

    isAnimating = true;
    fadePhase = 'out';

    const handleTransition = (event) => {
      if (event.propertyName !== 'opacity') return;

      if (fadePhase === 'out') {
        // fade-out finished → change image, then fade back in
        img.src = getRandomImage();
        fadePhase = 'in';
        img.style.opacity = '1';
      } else if (fadePhase === 'in') {
        // fade-in finished → clean up
        img.removeEventListener('transitionend', handleTransition);
        fadePhase = 'idle';
        isAnimating = false;
      }
    };

    img.addEventListener('transitionend', handleTransition);

    // start fade-out
    img.style.opacity = '0';
  }

  // Initialize: start with a random image (or use existing if it's one of our product images)
  document.addEventListener('DOMContentLoaded', () => {
    const img = document.getElementById('product-image');
    if (img) {
      // Check if current image is one of our product images
      const currentSrc = img.getAttribute('src') || '';
      const currentIndex = productImages.findIndex(imgPath => currentSrc === imgPath || currentSrc.endsWith(imgPath));
      
      if (currentIndex !== -1) {
        // Use the current image as starting point
        currentImageIndex = currentIndex;
      } else {
        // Set initial random image
        const initialImage = getRandomImage();
        img.src = initialImage;
      }

      // Ensure starting state is fully visible
      img.style.opacity = '1';
      
      // Change image every 3 seconds
      setInterval(changeProductImage, 3000);
    }
  });
</script>
